##########
# snippets
##########

# TODO: rename gateway, since it is not a gateway anymore
(gateway_proxy) {
  reverse_proxy gateway:8000 {
    header_up X-Real-IP {remote_host}
    header_up X-Forwarded-Uri {uri}
    header_up Host {host}
  }
}

(backend_proxy) {
  reverse_proxy backend:8000 {
    header_up Host {host}
  }
}

(frontend_proxy) {
  reverse_proxy frontend:8000 {
    header_up Host {host}
  }
}

(idp_proxy) {
  reverse_proxy idp:8080 {
    header_up Host {host}
  }
}

(gateway_auth_common) {
  uri /oauth2/auth
  header_up X-Real-IP {remote_host}
  copy_headers X-FFun-User-Id X-FFun-Identity-Provider-Id
}

#######
# sites
#######

feeds.fun.local {
  tls internal

  handle /oauth2/* {
    import gateway_proxy
  }

  handle /spa/auth/logout {
    rewrite * /oauth2/sign_out?rd=/%3Flogged-out
    import gateway_proxy
  }

  handle /spa/auth/login {
    rewrite * /oauth2/start?rd={query.return_to}
    import gateway_proxy
  }

  handle /spa/auth/join {
    rewrite * /oauth2/start?prompt=create&rd={query.return_to}
    import gateway_proxy
  }

  handle /spa/auth/* {
    forward_auth gateway:8000 {
      import gateway_auth_common

      @unauth status 401
      handle_response @unauth {
        redir * /oauth2/sign_in?rd={scheme}://{host}{uri}
      }
    }

    import backend_proxy
  }

  handle /spa/api/private/* {
    forward_auth gateway:8000 {
      import gateway_auth_common
    }

    import backend_proxy
  }

  handle /spa/* {
    import backend_proxy
  }

  handle {
    import frontend_proxy
  }
}

idp.feeds.fun.local {
  tls internal

  import idp_proxy
}

# Is required by Pomerium (see configs)
# Skip if you don't use Pomerium
auth.feeds.fun.local {
  tls internal

  import gateway_proxy
}
