
x-openid-common-properties: &openid-common-properties
  session:
    secret: "84b45ebe-abcf-406e-a4e9-6e9916229c07"
  use_pkce: true
  client_id: apisix-client
  client_secret: a5tAGfAvr1A2nACmPRSlxMTJyJ6yoEuq
  discovery: http://feeds.fun.local/realms/dev/.well-known/openid-configuration
  scope: "openid"
  # set user info header to extract user id later,
  # after that the header will be removed
  set_userinfo_header: true

x-serverless-pre-function: &serverless-pre-function
  phase: rewrite
  functions:
    - |
      return function(conf, ctx)
        local cjson = require "cjson.safe"

        local raw = ngx.req.get_headers()["x-userinfo"]

        if raw then
          local u = cjson.decode(raw)

          if u and u.sub then
            ngx.req.set_header("X-FFun-User-Id", u.sub)
          end

          ngx.req.clear_header("X-Userinfo")
        end

        -- your small, static identifier for this gateway/config
        ngx.req.set_header("X-FFun-Identity-Provider-Id", "keycloak")
      end

upstreams:
  - name: backend
    id: 1
    nodes:
      "backend:8000": 1
    type: roundrobin

routes:

  - uri: /spa/docs
    upstream_id: 1

  - uri: /spa/test
    upstream_id: 1

  - uris:
      - /spa/login
      - /spa/login/*
    upstream_id: 1
    plugins:
      serverless-pre-function:
        <<: *serverless-pre-function

      openid-connect:
        <<: *openid-common-properties
        unauth_action: auth
        redirect_uri: /spa/login/redirect

  - uri: /spa/api/public/*
    upstream_id: 1
    plugins:
      serverless-pre-function:
        <<: *serverless-pre-function

      openid-connect:
        <<: *openid-common-properties
        unauth_action: pass

  - uri: /spa/api/private/*
    upstream_id: 1
    plugins:
      serverless-pre-function:
        <<: *serverless-pre-function

      openid-connect:
        <<: *openid-common-properties
        unauth_action: deny

#END
