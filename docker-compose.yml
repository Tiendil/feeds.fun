version: "3.9"


volumes:
  ffun_postgresql_data: {}


networks:
  ffun_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/16


services:

  postgresql:
    image: postgres:15-bullseye

    volumes:
      - ffun_postgresql_data:/var/lib/postgresql/data
      - ./docker/postgresql/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d

    environment:
      POSTGRES_MULTIPLE_DATABASES: ffun,supertokens
      POSTGRES_DB: default
      POSTGRES_USER: root
      POSTGRES_PASSWORD: root

    ports:
      - "5432:5432"

    networks:
      ffun_network: {}

  supertokens:
    image: registry.supertokens.io/supertokens/supertokens-postgresql

    depends_on:
      postgresql:
        condition: service_started

    environment:
      POSTGRESQL_DATABASE_NAME: "supertokens"
      POSTGRESQL_USER: "supertokens"
      POSTGRESQL_PASSWORD: "supertokens"
      POSTGRESQL_HOST: "postgresql"
      POSTGRESQL_PORT: "5432"

    ports:
      - "3567:3567"

    networks:
      ffun_network: {}

  backend-migrations:
    build:
      context: ./
      dockerfile: ./docker/backend/Dockerfile

    depends_on:
      postgresql:
        condition: service_started

    command: "poetry run yoyo apply"

    volumes:
      - ${PWD}/ffun:/repository

    networks:
      ffun_network: {}

  backend:
    build:
      context: ./
      dockerfile: ./docker/backend/Dockerfile

    depends_on:
      postgresql:
        condition: service_started
      supertokens:
        condition: service_started
      backend-migrations:
        condition: service_completed_successfully

    command: "poetry run ffun server --api --supertokens"

    volumes:
      - ${PWD}/ffun:/repository

    environment:
      FFUN_AUTH_MODE: "${FFUN_AUTH_MODE}"

    ports:
      - "8000:8000"

    networks:
      ffun_network: {}


  frontend:
    build:
      context: ./
      dockerfile: ./docker/frontend/Dockerfile

    depends_on:
      backend:
        condition: service_started

    command: "npm run dev -- --host 0.0.0.0"

    volumes:
      - ${PWD}/site:/repository

    environment:
      VITE_FFUN_AUTH_MODE: "${FFUN_AUTH_MODE}"

    ports:
      - "5173:5173"

    networks:
      ffun_network: {}
